on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'catalog-info.yaml'
      - 'renovate.json'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

env:
  OPA_VERSION: 0.67.1

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 #v4.1.7
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5 #v2.2.0
        with:
          version: ${{ env.OPA_VERSION }}
      - name: Run OPA Tests
        run: opa test -v ./policy
      - name: Check OPA Policies
        run: opa check ./policy

  release:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'Merge pull request') }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 #v4.1.7
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5 #v2.2.0
        with:
          version: ${{ env.OPA_VERSION }}
      - name: Build OPA Bundle
        run: |
          opa \
            build \
            --bundle ./policy \
            --ignore "*_test.rego" \
            --output bundle.tar.gz
      - name: Run go-semantic-release
        uses: go-semantic-release/action@48d83acd958dae62e73701aad20a5b5844a3bf45 # v1.23.0
        id: go-semantic-release
        with:
          github-token: ${{ github.token }}
          changelog-generator-opt: emojis=true
          allow-initial-development-versions: true
      - name: Upload Release Asset
        if: steps.go-semantic-release.outputs.version != ''
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          files: bundle.tar.gz
          tag_name: v${{ steps.go-semantic-release.outputs.version }}
          token: ${{ github.token }}
